{
  "id": "observability_monitoring_prometheus_configuration",
  "name": "prometheus-configuration",
  "source": "observability-monitoring",
  "originalPath": "plugins/observability-monitoring/skills/prometheus-configuration/SKILL.md",
  "activationCriteria": "Set up Prometheus for comprehensive metric collection, storage, and monitoring of infrastructure and applications. Use when implementing metrics collection, setting up monitoring infrastructure, or co",
  "tier1_metadata": "prometheus-configuration: Set up Prometheus for comprehensive metric collection, storage, and monitoring of infrastructure and",
  "tier2_instructions": "# Prometheus Configuration\n\nComplete guide to Prometheus setup, metric collection, scrape configuration, and recording rules.\n\n## Purpose\n\nConfigure Prometheus for comprehensive metric collection, alerting, and monitoring of infrastructure and applications.\n\n## When to Use\n\n- Set up Prometheus monitoring\n- Configure metric scraping\n- Create recording rules\n- Design alert rules\n- Implement service discovery\n\n## Prometheus Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Applications \u2502 \u2190 Instrumented with client libraries\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502 /metrics endpoint\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Prometheus  \u2502 \u2190 Scrapes metrics periodically\n\u2502    Server    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u251c\u2500\u2192 AlertManager (alerts)\n       \u251c\u2500\u2192 Grafana (visualization)\n       \u2514\u2500\u2192 Long-term storage (Thanos/Cortex)\n```\n\n## Installation\n\n### Kubernetes with Helm\n\n```bash\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm install prometheus prometheus-community/kube-prometheus-stack \\\n  --namespace monitoring \\\n  --create-namespace \\\n  --set prometheus.prometheusSpec.retention=30d \\\n  --set prometheus.prometheusSpec.storageVolumeSize=50Gi\n```\n\n### Docker Compose\n\n```yaml\nversion: '3.8'\nservices:\n  prometheus:\n    image: prom/prometheus:latest\n    ports:\n      - \"9090:9090\"\n    volumes:\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n      - prometheus-data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n      - '--storage.tsdb.path=/prometheus'\n      - '--storage.tsdb.retention.time=30d'\n\nvolumes:\n  prometheus-data:\n```\n\n## Configuration File\n\n**prometheus.yml:**\n```yaml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n  external_labels:\n    cluster: 'production'\n    region: 'us-west-2'\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          - alertmanager:9093\n\n# Load rules files\nrule_files:\n  - /etc/prometheus/rules/*.yml\n\n# Scrape configurations\ns",
  "tier3_resources": "crape_configs:\n  # Prometheus itself\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  # Node exporters\n  - job_name: 'node-exporter'\n    static_configs:\n      - targets:\n        - 'node1:9100'\n        - 'node2:9100'\n        - 'node3:9100'\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: instance\n        regex: '([^:]+)(:[0-9]+)?'\n        replacement: '${1}'\n\n  # Kubernetes pods with annotations\n  - job_name: 'kubernetes-pods'\n    kubernetes_sd_configs:\n      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n        action: replace\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        target_label: __address__\n      - source_labels: [__meta_kubernetes_namespace]\n        action: replace\n        target_label: namespace\n      - source_labels: [__meta_kubernetes_pod_name]\n        action: replace\n        target_label: pod\n\n  # Application metrics\n  - job_name: 'my-app'\n    static_configs:\n      - targets:\n        - 'app1.example.com:9090'\n        - 'app2.example.com:9090'\n    metrics_path: '/metrics'\n    scheme: 'https'\n    tls_config:\n      ca_file: /etc/prometheus/ca.crt\n      cert_file: /etc/prometheus/client.crt\n      key_file: /etc/prometheus/client.key\n```\n\n**Reference:** See `assets/prometheus.yml.template`\n\n## Scrape Configurations\n\n### Static Targets\n\n```yaml\nscrape_configs:\n  - job_name: 'static-targets'\n    static_configs:\n      - targets: ['host1:9100', 'host2:9100']\n        labels:\n          env: 'production'\n          region: 'us-west-2'\n```\n\n### File-based Service Discovery\n\n```yaml\nscrape_configs:\n  - job_name: 'file-sd'\n    file_sd_configs:\n      - files:\n        - /etc/prometheus/targets/*.json\n        - /etc/prometheus/targets/*.yml\n        refresh_interval: 5m\n```\n\n**targets/production.json:**\n```json\n[\n  {\n    \"targets\": [\"app1:9090\", \"app2:9090\"],\n    \"labels\": {\n      \"env\": \"production\",\n      \"service\": \"api\"\n    }\n  }\n]\n```\n\n### Kubernetes Service Discovery\n\n```yaml\nscrape_configs:\n  - job_name: 'kubernetes-services'\n    kubernetes_sd_configs:\n      - role: service\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n        action: replace\n        target_label: __scheme__\n        regex: (https?)\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n```\n\n**Reference:** See `references/scrape-configs.md`\n\n## Recordin",
  "tokenEstimate": {
    "tier1": 18.2,
    "tier2": 250.9,
    "tier3": 916.5
  },
  "fullDefinition": "---\nname: prometheus-configuration\ndescription: Set up Prometheus for comprehensive metric collection, storage, and monitoring of infrastructure and applications. Use when implementing metrics collection, setting up monitoring infrastructure, or configuring alerting systems.\n---\n\n# Prometheus Configuration\n\nComplete guide to Prometheus setup, metric collection, scrape configuration, and recording rules.\n\n## Purpose\n\nConfigure Prometheus for comprehensive metric collection, alerting, and monitoring of infrastructure and applications.\n\n## When to Use\n\n- Set up Prometheus monitoring\n- Configure metric scraping\n- Create recording rules\n- Design alert rules\n- Implement service discovery\n\n## Prometheus Architecture\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Applications \u2502 \u2190 Instrumented with client libraries\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502 /metrics endpoint\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Prometheus  \u2502 \u2190 Scrapes metrics periodically\n\u2502    Server    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u251c\u2500\u2192 AlertManager (alerts)\n       \u251c\u2500\u2192 Grafana (visualization)\n       \u2514\u2500\u2192 Long-term storage (Thanos/Cortex)\n```\n\n## Installation\n\n### Kubernetes with Helm\n\n```bash\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm install prometheus prometheus-community/kube-prometheus-stack \\\n  --namespace monitoring \\\n  --create-namespace \\\n  --set prometheus.prometheusSpec.retention=30d \\\n  --set prometheus.prometheusSpec.storageVolumeSize=50Gi\n```\n\n### Docker Compose\n\n```yaml\nversion: '3.8'\nservices:\n  prometheus:\n    image: prom/prometheus:latest\n    ports:\n      - \"9090:9090\"\n    volumes:\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n      - prometheus-data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n      - '--storage.tsdb.path=/prometheus'\n      - '--storage.tsdb.retention.time=30d'\n\nvolumes:\n  prometheus-data:\n```\n\n## Configuration File\n\n**prometheus.yml:**\n```yaml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n  external_labels:\n    cluster: 'production'\n    region: 'us-west-2'\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          - alertmanager:9093\n\n# Load rules files\nrule_files:\n  - /etc/prometheus/rules/*.yml\n\n# Scrape configurations\nscrape_configs:\n  # Prometheus itself\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  # Node exporters\n  - job_name: 'node-exporter'\n    static_configs:\n      - targets:\n        - 'node1:9100'\n        - 'node2:9100'\n        - 'node3:9100'\n    relabel_configs:\n      - source_labels: [__address__]\n        target_label: instance\n        regex: '([^:]+)(:[0-9]+)?'\n        replacement: '${1}'\n\n  # Kubernetes pods with annotations\n  - job_name: 'kubernetes-pods'\n    kubernetes_sd_configs:\n      - role: pod\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n        action: replace\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        target_label: __address__\n      - source_labels: [__meta_kubernetes_namespace]\n        action: replace\n        target_label: namespace\n      - source_labels: [__meta_kubernetes_pod_name]\n        action: replace\n        target_label: pod\n\n  # Application metrics\n  - job_name: 'my-app'\n    static_configs:\n      - targets:\n        - 'app1.example.com:9090'\n        - 'app2.example.com:9090'\n    metrics_path: '/metrics'\n    scheme: 'https'\n    tls_config:\n      ca_file: /etc/prometheus/ca.crt\n      cert_file: /etc/prometheus/client.crt\n      key_file: /etc/prometheus/client.key\n```\n\n**Reference:** See `assets/prometheus.yml.template`\n\n## Scrape Configurations\n\n### Static Targets\n\n```yaml\nscrape_configs:\n  - job_name: 'static-targets'\n    static_configs:\n      - targets: ['host1:9100', 'host2:9100']\n        labels:\n          env: 'production'\n          region: 'us-west-2'\n```\n\n### File-based Service Discovery\n\n```yaml\nscrape_configs:\n  - job_name: 'file-sd'\n    file_sd_configs:\n      - files:\n        - /etc/prometheus/targets/*.json\n        - /etc/prometheus/targets/*.yml\n        refresh_interval: 5m\n```\n\n**targets/production.json:**\n```json\n[\n  {\n    \"targets\": [\"app1:9090\", \"app2:9090\"],\n    \"labels\": {\n      \"env\": \"production\",\n      \"service\": \"api\"\n    }\n  }\n]\n```\n\n### Kubernetes Service Discovery\n\n```yaml\nscrape_configs:\n  - job_name: 'kubernetes-services'\n    kubernetes_sd_configs:\n      - role: service\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n        action: replace\n        target_label: __scheme__\n        regex: (https?)\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n```\n\n**Reference:** See `references/scrape-configs.md`\n\n## Recording Rules\n\nCreate pre-computed metrics for frequently queried expressions:\n\n```yaml\n# /etc/prometheus/rules/recording_rules.yml\ngroups:\n  - name: api_metrics\n    interval: 15s\n    rules:\n      # HTTP request rate per service\n      - record: job:http_requests:rate5m\n        expr: sum by (job) (rate(http_requests_total[5m]))\n\n      # Error rate percentage\n      - record: job:http_requests_errors:rate5m\n        expr: sum by (job) (rate(http_requests_total{status=~\"5..\"}[5m]))\n\n      - record: job:http_requests_error_rate:percentage\n        expr: |\n          (job:http_requests_errors:rate5m / job:http_requests:rate5m) * 100\n\n      # P95 latency\n      - record: job:http_request_duration:p95\n        expr: |\n          histogram_quantile(0.95,\n            sum by (job, le) (rate(http_request_duration_seconds_bucket[5m]))\n          )\n\n  - name: resource_metrics\n    interval: 30s\n    rules:\n      # CPU utilization percentage\n      - record: instance:node_cpu:utilization\n        expr: |\n          100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)\n\n      # Memory utilization percentage\n      - record: instance:node_memory:utilization\n        expr: |\n          100 - ((node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100)\n\n      # Disk usage percentage\n      - record: instance:node_disk:utilization\n        expr: |\n          100 - ((node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100)\n```\n\n**Reference:** See `references/recording-rules.md`\n\n## Alert Rules\n\n```yaml\n# /etc/prometheus/rules/alert_rules.yml\ngroups:\n  - name: availability\n    interval: 30s\n    rules:\n      - alert: ServiceDown\n        expr: up{job=\"my-app\"} == 0\n        for: 1m\n        labels:\n          severity: critical\n        annotations:\n          summary: \"Service {{ $labels.instance }} is down\"\n          description: \"{{ $labels.job }} has been down for more than 1 minute\"\n\n      - alert: HighErrorRate\n        expr: job:http_requests_error_rate:percentage > 5\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High error rate for {{ $labels.job }}\"\n          description: \"Error rate is {{ $value }}% (threshold: 5%)\"\n\n      - alert: HighLatency\n        expr: job:http_request_duration:p95 > 1\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High latency for {{ $labels.job }}\"\n          description: \"P95 latency is {{ $value }}s (threshold: 1s)\"\n\n  - name: resources\n    interval: 1m\n    rules:\n      - alert: HighCPUUsage\n        expr: instance:node_cpu:utilization > 80\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High CPU usage on {{ $labels.instance }}\"\n          description: \"CPU usage is {{ $value }}%\"\n\n      - alert: HighMemoryUsage\n        expr: instance:node_memory:utilization > 85\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High memory usage on {{ $labels.instance }}\"\n          description: \"Memory usage is {{ $value }}%\"\n\n      - alert: DiskSpaceLow\n        expr: instance:node_disk:utilization > 90\n        for: 5m\n        labels:\n          severity: critical\n        annotations:\n          summary: \"Low disk space on {{ $labels.instance }}\"\n          description: \"Disk usage is {{ $value }}%\"\n```\n\n## Validation\n\n```bash\n# Validate configuration\npromtool check config prometheus.yml\n\n# Validate rules\npromtool check rules /etc/prometheus/rules/*.yml\n\n# Test query\npromtool query instant http://localhost:9090 'up'\n```\n\n**Reference:** See `scripts/validate-prometheus.sh`\n\n## Best Practices\n\n1. **Use consistent naming** for metrics (prefix_name_unit)\n2. **Set appropriate scrape intervals** (15-60s typical)\n3. **Use recording rules** for expensive queries\n4. **Implement high availability** (multiple Prometheus instances)\n5. **Configure retention** based on storage capacity\n6. **Use relabeling** for metric cleanup\n7. **Monitor Prometheus itself**\n8. **Implement federation** for large deployments\n9. **Use Thanos/Cortex** for long-term storage\n10. **Document custom metrics**\n\n## Troubleshooting\n\n**Check scrape targets:**\n```bash\ncurl http://localhost:9090/api/v1/targets\n```\n\n**Check configuration:**\n```bash\ncurl http://localhost:9090/api/v1/status/config\n```\n\n**Test query:**\n```bash\ncurl 'http://localhost:9090/api/v1/query?query=up'\n```\n\n## Reference Files\n\n- `assets/prometheus.yml.template` - Complete configuration template\n- `references/scrape-configs.md` - Scrape configuration patterns\n- `references/recording-rules.md` - Recording rule examples\n- `scripts/validate-prometheus.sh` - Validation script\n\n## Related Skills\n\n- `grafana-dashboards` - For visualization\n- `slo-implementation` - For SLO monitoring\n- `distributed-tracing` - For request tracing\n"
}